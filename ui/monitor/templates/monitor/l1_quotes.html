<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L1 Quotes - Trading Monitor</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #0a0a0a;
            color: #ffffff;
            font-size: 13px;
            line-height: 1.2;
        }
        
        .header {
            background: #1a1a1a;
            padding: 10px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .header h1 {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
        }
        
        .market-status {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }
        
        .status-indicator {
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .status-open { background: #004400; color: #00ff00; }
        .status-closed { background: #440000; color: #ff4444; }
        .status-unknown { background: #444400; color: #ffff00; }
        
        .controls {
            background: #1a1a1a;
            padding: 10px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .watchlist-input {
            background: #2a2a2a;
            border: 1px solid #444;
            color: #fff;
            padding: 5px 10px;
            border-radius: 3px;
            font-family: inherit;
            font-size: 12px;
            width: 300px;
        }
        
        .btn {
            background: #0066cc;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
        }
        
        .btn:hover {
            background: #0080ff;
        }
        
        .btn-secondary {
            background: #666;
        }
        
        .btn-secondary:hover {
            background: #888;
        }
        
        .quotes-grid {
            margin: 20px;
            border: 1px solid #333;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .grid-header {
            background: #2a2a2a;
            display: grid;
            grid-template-columns: 80px 80px 80px 80px 80px 100px 100px 80px 80px 120px 80px;
            gap: 1px;
            border-bottom: 2px solid #444;
        }
        
        .grid-header > div {
            padding: 8px 6px;
            font-weight: bold;
            color: #cccccc;
            text-align: center;
            font-size: 11px;
        }
        
        .quote-row {
            display: grid;
            grid-template-columns: 80px 80px 80px 80px 80px 100px 100px 80px 80px 120px 80px;
            gap: 1px;
            border-bottom: 1px solid #2a2a2a;
            background: #1a1a1a;
        }
        
        .quote-row:hover {
            background: #252525;
        }
        
        .quote-cell {
            padding: 6px;
            text-align: center;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .symbol-cell {
            font-weight: bold;
            color: #00ccff;
            justify-content: left;
            padding-left: 10px;
        }
        
        .price-cell {
            font-weight: bold;
        }
        
        .bid-cell { color: #66ff66; }
        .ask-cell { color: #ff6666; }
        .last-cell { color: #ffff66; }
        
        .size-cell {
            color: #aaaaaa;
            font-size: 11px;
        }
        
        .spread-cell {
            color: #ffffff;
        }
        
        .spread-wide { color: #ff6666; }
        .spread-normal { color: #ffff66; }
        .spread-tight { color: #66ff66; }
        
        .age-cell {
            color: #999999;
            font-size: 10px;
        }
        
        .age-fresh { color: #66ff66; }
        .age-stale { color: #ffff66; }
        .age-old { color: #ff6666; }
        
        .quality-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin: 0 auto;
        }
        
        .quality-good { background: #66ff66; }
        .quality-warning { background: #ffff66; }
        .quality-error { background: #ff6666; }
        .quality-no-data { background: #666666; }
        
        .no-data-row {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }
        
        .error-message {
            background: #440000;
            color: #ff4444;
            padding: 10px 20px;
            margin: 20px;
            border-radius: 5px;
            border: 1px solid #664444;
        }
        
        .update-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #004400;
            color: #00ff00;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .update-indicator.show {
            opacity: 1;
        }
        
        @media (max-width: 1200px) {
            .grid-header,
            .quote-row {
                grid-template-columns: 60px 60px 60px 60px 60px 80px 80px 60px 60px 100px 60px;
            }
            
            .quotes-grid {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>L1 QUOTES</h1>
        <div class="market-status">
            <div id="market-status" class="status-indicator status-unknown">UNKNOWN</div>
            <div id="data-status" class="status-indicator status-unknown">NO DATA</div>
            <div id="current-time"></div>
        </div>
    </div>
    
    <div class="controls">
        <input 
            type="text" 
            id="watchlist-input" 
            class="watchlist-input" 
            placeholder="Enter symbols (comma-separated): AAPL,GOOGL,MSFT"
            value="AAPL,GOOGL,MSFT,TSLA"
        >
        <button class="btn" onclick="updateWatchlist()">Update Watchlist</button>
        <button class="btn btn-secondary" onclick="toggleAutoRefresh()">Auto Refresh: ON</button>
        <button class="btn btn-secondary" onclick="refreshNow()">Refresh Now</button>
    </div>
    
    <div class="quotes-grid">
        <div class="grid-header">
            <div>SYMBOL</div>
            <div>BID</div>
            <div>BID SIZE</div>
            <div>ASK</div>
            <div>ASK SIZE</div>
            <div>SPREAD</div>
            <div>SPREAD %</div>
            <div>LAST</div>
            <div>LAST SIZE</div>
            <div>AGE</div>
            <div>QUALITY</div>
        </div>
        
        <div id="quotes-container">
            <div class="no-data-row">Loading quotes...</div>
        </div>
    </div>
    
    <div id="error-container"></div>
    <div id="update-indicator" class="update-indicator">Updated</div>
    
    <script>
        let autoRefreshEnabled = true;
        let refreshInterval = null;
        let currentWatchlist = ['AAPL', 'GOOGL', 'MSFT', 'TSLA'];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadWatchlist();
            updateMarketStatus();
            startAutoRefresh();
            updateCurrentTime();
            
            // Update time every second
            setInterval(updateCurrentTime, 1000);
        });
        
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', {
                timeZone: 'America/New_York',
                hour12: false
            });
            document.getElementById('current-time').textContent = timeStr + ' ET';
        }
        
        function loadWatchlist() {
            // Add timeout protection to prevent hanging
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
            
            fetch('/api/downloader/l1-quotes/watchlist/', {
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    return response.json();
                })
                .then(data => {
                    if (data.watchlist) {
                        currentWatchlist = data.watchlist;
                        document.getElementById('watchlist-input').value = currentWatchlist.join(',');
                        refreshQuotes();
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.error('Watchlist loading timed out');
                        showError('Watchlist loading timed out - using defaults');
                    } else {
                        console.error('Error loading watchlist:', error);
                    }
                    refreshQuotes(); // Still try to load quotes with default symbols
                });
        }
        
        function updateWatchlist() {
            const input = document.getElementById('watchlist-input').value;
            const symbols = input.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            
            if (symbols.length === 0) {
                showError('Please enter at least one symbol');
                return;
            }
            
            fetch('/api/downloader/l1-quotes/update_watchlist/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ symbols: symbols })
            })
            .then(response => response.json())
            .then(data => {
                if (data.watchlist) {
                    currentWatchlist = data.watchlist;
                    document.getElementById('watchlist-input').value = currentWatchlist.join(',');
                    showUpdateIndicator();
                    refreshQuotes();
                }
            })
            .catch(error => {
                console.error('Error updating watchlist:', error);
                showError('Failed to update watchlist');
            });
        }
        
        function refreshQuotes() {
            if (currentWatchlist.length === 0) return;
            
            const symbolsParam = currentWatchlist.join(',');
            
            // Add timeout protection for quote fetching 
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
            
            fetch(`/api/downloader/l1-quotes/live_quotes/?symbols=${symbolsParam}`, {
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    return response.json();
                })
                .then(data => {
                    if (data.quotes) {
                        displayQuotes(data.quotes);
                        clearError();
                    } else {
                        showError('No quote data received');
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.error('Quote fetching timed out');
                        showError('Quote fetching timed out - retrying...');
                    } else {
                        console.error('Error fetching quotes:', error);
                        showError('Failed to fetch quotes: ' + error.message);
                    }
                });
        }
        
        function displayQuotes(quotes) {
            const container = document.getElementById('quotes-container');
            
            if (quotes.length === 0) {
                container.innerHTML = '<div class="no-data-row">No quotes available</div>';
                return;
            }
            
            container.innerHTML = quotes.map(quote => {
                if (quote.error) {
                    return `
                        <div class="quote-row">
                            <div class="quote-cell symbol-cell">${quote.symbol}</div>
                            <div class="quote-cell" style="grid-column: 2 / -1; color: #ff6666; text-align: left; padding-left: 20px;">
                                ERROR: ${quote.error}
                            </div>
                        </div>
                    `;
                }
                
                const ageClass = getAgeClass(quote.age_seconds);
                const spreadClass = getSpreadClass(quote.data_quality);
                const qualityClass = getQualityClass(quote.data_quality);
                
                return `
                    <div class="quote-row">
                        <div class="quote-cell symbol-cell">${quote.symbol}</div>
                        <div class="quote-cell price-cell bid-cell">${formatPrice(quote.bid)}</div>
                        <div class="quote-cell size-cell">${formatSize(quote.bid_size)}</div>
                        <div class="quote-cell price-cell ask-cell">${formatPrice(quote.ask)}</div>
                        <div class="quote-cell size-cell">${formatSize(quote.ask_size)}</div>
                        <div class="quote-cell spread-cell ${spreadClass}">${formatPrice(quote.spread)}</div>
                        <div class="quote-cell spread-cell ${spreadClass}">${quote.spread_pct}%</div>
                        <div class="quote-cell price-cell last-cell">${formatPrice(quote.last_price)}</div>
                        <div class="quote-cell size-cell">${formatSize(quote.last_size)}</div>
                        <div class="quote-cell age-cell ${ageClass}">${formatAge(quote.age_seconds)}</div>
                        <div class="quote-cell">
                            <div class="quality-indicator ${qualityClass}" title="${quote.data_quality}"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateMarketStatus() {
            // Add timeout protection for market status
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout
            
            fetch('/api/downloader/l1-quotes/market_status/', {
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    return response.json();
                })
                .then(data => {
                    const marketStatus = document.getElementById('market-status');
                    const dataStatus = document.getElementById('data-status');
                    
                    if (data.market_open) {
                        marketStatus.textContent = 'MARKET OPEN';
                        marketStatus.className = 'status-indicator status-open';
                    } else {
                        marketStatus.textContent = 'MARKET CLOSED';
                        marketStatus.className = 'status-indicator status-closed';
                    }
                    
                    const availability = data.data_availability;
                    if (availability === 'good') {
                        dataStatus.textContent = 'DATA LIVE';
                        dataStatus.className = 'status-indicator status-open';
                    } else if (availability === 'limited') {
                        dataStatus.textContent = 'DATA LIMITED';
                        dataStatus.className = 'status-indicator status-unknown';
                    } else if (availability === 'redis_unavailable') {
                        dataStatus.textContent = 'REDIS DOWN';
                        dataStatus.className = 'status-indicator status-closed';
                    } else {
                        dataStatus.textContent = 'NO DATA';
                        dataStatus.className = 'status-indicator status-closed';
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        console.error('Market status check timed out');
                        // Update UI to show timeout
                        const dataStatus = document.getElementById('data-status');
                        dataStatus.textContent = 'TIMEOUT';
                        dataStatus.className = 'status-indicator status-closed';
                    } else {
                        console.error('Error fetching market status:', error);
                    }
                });
        }
        
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = event.target;
            
            if (autoRefreshEnabled) {
                btn.textContent = 'Auto Refresh: ON';
                startAutoRefresh();
            } else {
                btn.textContent = 'Auto Refresh: OFF';
                stopAutoRefresh();
            }
        }
        
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            
            refreshInterval = setInterval(() => {
                if (autoRefreshEnabled) {
                    refreshQuotes();
                    updateMarketStatus();
                    showUpdateIndicator();
                }
            }, 2000); // Refresh every 2 seconds
        }
        
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }
        
        function refreshNow() {
            refreshQuotes();
            updateMarketStatus();
            showUpdateIndicator();
        }
        
        function showUpdateIndicator() {
            const indicator = document.getElementById('update-indicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1000);
        }
        
        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">ERROR: ${message}</div>`;
        }
        
        function clearError() {
            document.getElementById('error-container').innerHTML = '';
        }
        
        // Utility functions
        function formatPrice(price) {
            if (!price || price === 0) return '---';
            return price.toFixed(2);
        }
        
        function formatSize(size) {
            if (!size || size === 0) return '--';
            return size.toLocaleString();
        }
        
        function formatAge(ageSeconds) {
            if (ageSeconds === null || ageSeconds === undefined) return '---';
            
            if (ageSeconds < 10) return ageSeconds.toFixed(1) + 's';
            if (ageSeconds < 60) return Math.round(ageSeconds) + 's';
            
            const minutes = Math.floor(ageSeconds / 60);
            if (minutes < 60) return minutes + 'm';
            
            const hours = Math.floor(minutes / 60);
            return hours + 'h';
        }
        
        function getAgeClass(ageSeconds) {
            if (ageSeconds === null || ageSeconds === undefined) return '';
            if (ageSeconds < 5) return 'age-fresh';
            if (ageSeconds < 30) return 'age-stale';
            return 'age-old';
        }
        
        function getSpreadClass(quality) {
            if (quality === 'tight_spread') return 'spread-tight';
            if (quality === 'normal_spread') return 'spread-normal';
            if (quality === 'wide_spread') return 'spread-wide';
            return '';
        }
        
        function getQualityClass(quality) {
            if (quality === 'tight_spread' || quality === 'normal_spread') return 'quality-good';
            if (quality === 'wide_spread') return 'quality-warning';
            if (quality === 'no_data') return 'quality-no-data';
            return 'quality-error';
        }
        
        function getCsrfToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            return '';
        }
    </script>
</body>
</html>